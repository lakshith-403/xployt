import {Quark, QuarkFunction as $} from '@ui_lib/quark';
import {View, ViewHandler} from '@ui_lib/view';
import './VulnerabilityReport.scss';
import {HackerProjects } from '@data/hacker/cache/hacker.projects';
import {CACHE_STORE} from '@data/cache';
import {Button, ButtonType} from "@components/button/base";
import { BasicInfoSection } from './components/basicInfo';
import { ProofOfConceptSection } from './components/proofOfConcept';
import {Project, ProjectCache} from "@data/common/cache/project.cache";
import {validateField} from "@components/multistepForm/validationUtils";

export interface formObject {
    vulnerabilityType: string;
    severity: string;
    reportTitle: string;
    description: string;
    steps: {
        description: string;
        attachments: string;
    }[];
    agreement: boolean;
}

export interface validation {
    result: boolean;
    message: string;
}

export class FieldErrorMessage {
    private message: string;
    private validation = true;

    constructor(message: string) {
        this.message = message;
    }

    render(q: Quark): void {
        this.message && $(q, 'div', 'error-message', {}, this.message.replace(/[^a-zA-Z0-9 ]/g, ''));
    }

}

export function handleInputChange(
    event: Event,
    formObject: any,
    formObjectKey: string,
    validationType: string,
    inputContainer: HTMLElement
): void {
    const value = (event.target as HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement).value;
    const validation = validateField(formObjectKey, value, validationType);

    if (validation.result) {
        formObject[formObjectKey] = value;
        console.log('Valid input:', formObject[formObjectKey]);
        const error = inputContainer.querySelector('.error-message');
        if (error) {
            error.remove();
        }
    } else {
        if (!inputContainer.querySelector('.error-message')) {
            new FieldErrorMessage(validation.message).render(inputContainer);
        }
    }
}

export class VulnerabilityReportFormView extends View {
    private projectId: string;
    private projectCache: ProjectCache;
    private ProjectInformation: Project | {} = {};
    private readonly formObject: formObject;
    private submitButton: Button;

    constructor(params: { projectId: string }, formData?: formObject) {
        super(params);
        this.projectId = params.projectId;
        this.projectCache = CACHE_STORE.getProject(this.projectId);
        this.formObject = formData || {
            vulnerabilityType: '',
            severity: '',
            reportTitle: '',
            description: '',
            steps: [],
            agreement: false
        };
        this.submitButton = new Button({
            label: 'Submit Report',
            type: ButtonType.PRIMARY,
            onClick: (e: Event) => {
                e.preventDefault();
                this.handleSubmit();
            }
        });
        console.log('params: ', params);
    }

    async loadProjectData(): Promise<void> {
        try {
            this.ProjectInformation = await this.projectCache.get(false, this.projectId) as Project;
        } catch (error) {
            console.error('Failed to load project data:', error);
        }
    }

    private handleSubmit(): void {
        console.log('Form Submitted', this.formObject);
    }
    // todo: add conditional submitting + static report page
    async render(q: Quark): Promise<void> {
        const waiting = $(q, 'div', 'loading-screen', {}, (q) => {
            $(q, 'div', 'spinner', {});
        });

        await this.loadProjectData();
        waiting.innerHTML = '';
        waiting.remove();

        $(q, 'div', 'vulnerability-report hacker', {}, (q) => {
            $(q, 'h2', 'section-subtitle', {}, (q) => {
                q.innerHTML = `#${this.projectId} ${(this.ProjectInformation as HackerProjects).title}`;
            });
            $(q, 'h1', 'section-title', {}, (q) => {
                q.innerHTML = "Vulnerability Report";
            });
            $(q, 'form', '', {}, (q) => {
                new BasicInfoSection(this.formObject).render(q);
                new ProofOfConceptSection(this.formObject).render(q);
            });
        });
    }
}

export const vulnReportViewHandler = new ViewHandler(
    '/new-report/{reportId}',
    VulnerabilityReportFormView
);
