import {Quark, QuarkFunction as $} from '@ui_lib/quark';
import {Button, ButtonType} from "@components/button/base";
import {
    FieldErrorMessage,
    formObject,
    handleInputChange
} from "@views/hacker/VulnerabilityReport/VulnerabilityReportForm";
import {validateField} from '@/components/multistepForm/validationUtils';

export class StepComponent {
    private formObject: formObject;
    private files: File[];
    private stepNumber: number;

    constructor(formObject: formObject, files: File[], stepNumber: number) {
        this.formObject = formObject;
        this.files = files;
        this.stepNumber = stepNumber;
    }

    private addFiles(stepFiles: FileList): void {
        const fileNames = Array.from(stepFiles).map(file => file.name);
        this.formObject.steps[this.stepNumber - 1].attachments = fileNames.join(', ');
        this.files.push(...Array.from(stepFiles));
        console.log("All files", this.files);
    }

    private handleFileUploads(fileInput: HTMLInputElement, fileInputLabel: HTMLElement, parent: HTMLElement): void {
        const stepFiles = fileInput.files;
        if (!stepFiles) return;

        const prevLabel = fileInput.innerHTML;
        const invalidFile = Array.from(stepFiles).find(file => {
            const validation = validateField('file', file.name, 'file');
            if (!validation.result) {
                new FieldErrorMessage(validation.message).render(parent);
                fileInputLabel.innerHTML = prevLabel;
                return true;
            }
            return false;
        });

        if (invalidFile) return;

        fileInputLabel.innerHTML = Array.from(stepFiles)
            .map(file => file.name)
            .join(', ');

        this.addFiles(stepFiles);

        const error = parent.querySelector('.error-message');
        fileInputLabel.classList.remove('placeholder', 'error');
        if (error) error.remove();
    }

    render(q: Quark): void {
        $(q, 'div', 'step', {}, (q) => {
            $(q, 'span', 'step-number', {}, (q) => {
                q.innerHTML = `Step ${String(this.stepNumber).padStart(2, '0')}`;
            });
            $(q, 'div', 'step-content', {}, (q) => {
                $(q, 'span', 'form-element align-top', {}, (q) => {
                    $(q, 'label', 'label', {}, "Description");
                    $(q, 'div', '', {}, (input) => {
                        $(input, 'textarea', 'input description', {}, (q) => {
                            q.addEventListener('blur', (e) => {
                                handleInputChange(e, this.formObject.steps[this.stepNumber - 1], 'description', 'string', q.parentElement!);
                            });
                        });
                    })
                });
                $(q, 'span', 'form-element align-center', {}, (q) => {
                    $(q, 'label', 'label', {}, "Attachments");
                    $(q, 'div', '', {}, (input) => {
                        $(input, 'span', 'form-element', {}, (q) => {
                            const fileInputLabel = $(q, 'span', 'input placeholder', {}, (q) => {
                                q.innerHTML = 'No file chosen';
                            });
                            const fileInput = $(q, 'input', '', {type: 'file'}, (q) => {
                                q.addEventListener('change', (e) => {
                                    this.handleFileUploads(q as HTMLInputElement, fileInputLabel, input);
                                });
                            });
                            new Button({
                                label: "Choose File",
                                type: ButtonType.PRIMARY,
                                onClick: (e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    fileInput.click()
                                }
                            }).render(q);
                        });
                    })
                });
            });
        });
    }
}